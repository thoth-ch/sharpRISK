---
title: "raw_code"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(shiny)
library(DBI)
library(RSQLite)
library(glue)
library(ggimage)
library(magick)
library(ggrepel)
```

## Connect to database
```{r}
riskdb_path <- "risks.db"
riskdb_conn <- dbConnect(SQLite(), dbname = riskdb_path)
```

# Load risks ----

```{r}
load_risks <- function() {
  riskdb_conn <- dbConnect(SQLite(), riskdb_path)
    query <- sprintf("SELECT * FROM risks")
        risks <- dbGetQuery(riskdb_conn, query)
        dbDisconnect(riskdb_conn)
        risks
    }
```

testing the function
```{r}
load_risks()
```
## Simulating shiny input variables:
```{r}
input <- list()
input$risk_number <- 10
input$risk_name <- "risk10"
```

# Aggregate risk form data

```{r}
aggregate_risk_data <- reactive({
        fields <- c("risk_name", "risk_number")
        data <- sapply(fields, function(x) input[[x]])
        data
    })
```

making the function non reactive for testing
```{r}
aggregate_risk_data <- function(x) {
        fields <- c("risk_name", "risk_number")
        aggregated_risks <- sapply(fields, function(x) input[[x]])
        aggregated_risks
    }
```

testing the function
```{r}
aggregate_risk_data(input)
```
simulating the vector of the aggregated risk data for utilisation by the subsequent functions
```{r}
risk_test_vector <- aggregate_risk_data(input)
risk_test_vector
```

# Save risks sql instruction ----
    
```{r}
save_risk <- function(x) {
        riskdb_conn <- dbConnect(SQLite(), riskdb_path)
        # Construct the update query by looping over the data fields
        query <- sprintf(
            "INSERT INTO risks (%s) VALUES ('%s')",
            paste(names(x), collapse = ", "),
            paste(x, collapse = "', '")
        )
        # Submit the update query and disconnect
        dbGetQuery(riskdb_conn, query)
        dbDisconnect(riskdb_conn)
    }
```

testing the function
```{r}
save_risk(risk_test_vector)
```
# Delete risk sql instruction
    
```{r}
delete_risk <- function() {
        riskdb_conn <- dbConnect(SQLite(), riskdb_path)
        delete_risk_query <- sprintf(
            "DELETE FROM risks WHERE risk_number = %s",
            input$risk_number
        )
        # Submit the update query and disconnect
        dbGetQuery(riskdb_conn, delete_risk_query)
        dbDisconnect(riskdb_conn)
    }
```

test the function
```{r}
delete_risk()
```
# Heatmap plot with image background

```{r}
risks <- load_risks()

heatmap_ggplot <- risks %>% 
  ggplot(aes(x = risk_impact, y = risk_probability)) +
  geom_point() +
  geom_text(aes(label = risk_name, hjust = "left")) +
  scale_x_continuous(breaks = c(0, 1, 2, 3, 4, 5),
                     limits = c(0, 5)) +
  scale_y_continuous(breaks = c(0, 1, 2, 3, 4, 5),
                     limit = c(0, 5)) +
  theme_light() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) +
  labs(x = "Risk Impact",
       y = "Risk Probability")

heatmap_ggplot

ggbackground(heatmap_ggplot, "heatmap_borders.png")
  
```
# Heatmap plot 

```{r}
risks <- load_risks()

risks %>% 
  ggplot(aes(x = risk_impact, y = risk_probability)) +
  geom_point() +
  # geom_text(aes(label = risk_name, 
  #               hjust = "left",
  #               nudge_x = 1)) +
  geom_text_repel(aes(label = risk_name, 
                hjust = "left",
                nudge_x = 1)) +
  scale_x_continuous(breaks = c(0, 1, 2, 3, 4),
                     limits = c(-.5, 4.5)) +
  scale_y_continuous(breaks = c(0, 1, 2, 3, 4),
                     limit = c(-0.5, 4.5)) +
  theme_minimal() +
  labs(x = "Risk Impact",
       y = "Risk Probability")
```

# Risk color function

```{r}
risk_color <- function(risk_impact, risk_probability) {
  r_color <- case_when(
    risk_impact == 1 & risk_probability == 1 ~ "yellow",
    risk_impact == 1 & risk_probability == 2 ~ "yellow",
    risk_impact == 1 & risk_probability == 3 ~ "orange",
    risk_impact == 1 & risk_probability == 4 ~ "orange",
    risk_impact == 2 & risk_probability == 1 ~ "yellow",
    risk_impact == 2 & risk_probability == 2 ~ "orange",
    risk_impact == 2 & risk_probability == 3 ~ "orange",
    risk_impact == 2 & risk_probability == 4 ~ "red",
    risk_impact == 3 & risk_probability == 1 ~ "yellow",
    risk_impact == 3 & risk_probability == 2 ~ "orange",
    risk_impact == 3 & risk_probability == 3 ~ "red",
    risk_impact == 3 & risk_probability == 4 ~ "red",
    risk_impact == 4 & risk_probability == 1 ~ "orange",
    risk_impact == 4 & risk_probability == 2 ~ "orange",
    risk_impact == 4 & risk_probability == 3 ~ "red",
    risk_impact == 4 & risk_probability == 4 ~ "red",
    TRUE ~ "")
  r_color
}

risks_colored <- risks %>%
  mutate(r_color = risk_color(risk_impact, risk_probability))
  
```


# Risk plot with colored risks

```{r}
risks <- load_risks()

risks_colored <- risks %>%
  mutate(r_color = risk_color(risk_impact, risk_probability))

risks_colored %>% 
  ggplot(aes(x = risk_impact, y = risk_probability, color = r_color)) +
  geom_point() +
  geom_text_repel(aes(label = risk_name,
                hjust = "left",
                nudge_x = 1)) +
  scale_color_identity() +
  scale_x_continuous(breaks = c(0, 1, 2, 3, 4),
                     limits = c(-.5, 4.5)) +
  scale_y_continuous(breaks = c(0, 1, 2, 3, 4),
                     limit = c(-0.5, 4.5)) +
  theme_minimal() +
  labs(x = "Risk Impact",
       y = "Risk Probability")
```

# Shiny server deployment config

```{r}
rsconnect::setAccountInfo(name='red-datafactory', token='52DA421CC5E0FCD672FAFAE3B8FDB76F', secret='81kdlYmCfDkr9WkWasxd8fNfy5XQtBDot341q5m2')

```















